<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

  
  <title>utils API documentation</title>
  <meta name="description" content="Created on Fri Jan 06, 2023 by George Lu

Utility functions that are called by multiple different cl..." />


  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}
</style>
  <style type="text/css">
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/
</style>
  <style type="text/css">
  pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #ffffcc }
.codehilite { background: #f8f8f8; }
.codehilite .c { color: #3D7B7B; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #9C6500 } /* Comment.Preproc */
.codehilite .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.codehilite .gr { color: #E40000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #008400 } /* Generic.Inserted */
.codehilite .go { color: #717171 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #687822 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #717171; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #767600 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #A45A77 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #0000FF } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>
  <style type="text/css">
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}
</style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>
<div id="container">
  


















  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">

    <li class="set"><h3><a href="#header-functions">Functions</a></h3>
      
  <ul>
    <li class="mono"><a href="#utils.addProfileToDs">addProfileToDs</a></li>
    <li class="mono"><a href="#utils.add_methods_to_xarrays">add_methods_to_xarrays</a></li>
    <li class="mono"><a href="#utils.bin_profiles">bin_profiles</a></li>
    <li class="mono"><a href="#utils.combine_profiles">combine_profiles</a></li>
    <li class="mono"><a href="#utils.computeProfile">computeProfile</a></li>
    <li class="mono"><a href="#utils.computeStrainRates">computeStrainRates</a></li>
    <li class="mono"><a href="#utils.compute_coherence">compute_coherence</a></li>
    <li class="mono"><a href="#utils.compute_displacement">compute_displacement</a></li>
    <li class="mono"><a href="#utils.contains_dask_array">contains_dask_array</a></li>
    <li class="mono"><a href="#utils.dB">dB</a></li>
    <li class="mono"><a href="#utils.default_constants">default_constants</a></li>
    <li class="mono"><a href="#utils.displacement_timeseries">displacement_timeseries</a></li>
    <li class="mono"><a href="#utils.phase2range">phase2range</a></li>
    <li class="mono"><a href="#utils.sonify">sonify</a></li>
  </ul>

    </li>


    </ul>
  </div>

<article id="content">
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">utils</span> module</h1>
  <p>Created on Fri Jan 06, 2023 by George Lu</p>
<p>Utility functions that are called by multiple different classes</p>
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-utils', this);">Show source &equiv;</a></p>
  <div id="source-utils" class="source">
    <div class="codehilite"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Fri Jan 06, 2023 by George Lu</span>

<span class="sd">Utility functions that are called by multiple different classes</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>




<span class="k">def</span> <span class="nf">displacement_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> 
                            <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  
                            <span class="n">bin_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> 
                            <span class="n">lower_limit_on_fit</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">800.0</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute displacement, phase, coherence and associated uncertainties, as functions of depth and time, given a time series of complex ApRES profiles. </span>

<span class="sd">    Profiles offset by a user-defined number of time steps are compared to compute the time series of displacement. </span>
<span class="sd">    </span>
<span class="sd">    The time interval between outputted profiles is offset*dt where dt is the time between measurements. </span>

<span class="sd">    The profiles of displacement etc. are binned in depth, with bin_size samples in each bin.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - self (xr.DataArray): The input data array containing a time series of complex profiles.</span>
<span class="sd">    - offset (int, optional): The time offset between the two time series. Default is 1.</span>
<span class="sd">    - bin_size (int, optional): Size of the vertical bins. Default is 20.</span>

<span class="sd">    Returns:</span>
<span class="sd">    xr.Dataset: Timeseries of profiles of coherence, phase, displacement, and associated uncertainties, binned in depth.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># extract two time series</span>
    <span class="n">profile1_unaligned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">offset</span><span class="p">))</span>
    <span class="n">profile2_unaligned</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span>
    
    <span class="c1"># compute the binned coherence, phase, and displacement, with uncertainties and put them into an xarray dataset  </span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">compute_displacement</span><span class="p">(</span><span class="n">profile1_unaligned</span><span class="p">,</span> 
                              <span class="n">profile2_unaligned</span><span class="p">,</span> 
                              <span class="n">bin_size</span> <span class="o">=</span> <span class="n">bin_size</span><span class="p">,</span>
                              <span class="n">lower_limit_on_fit</span> <span class="o">=</span> <span class="n">lower_limit_on_fit</span><span class="p">)</span>

    <span class="c1"># add attributes related to the this processing</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;processing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Created by the displacement_timeseries function in xapres using an offset of </span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s2"> and bin size of </span><span class="si">{</span><span class="n">bin_size</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">ds</span>

<span class="k">def</span> <span class="nf">compute_displacement</span><span class="p">(</span><span class="n">profile1_unaligned</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> 
                        <span class="n">profile2_unaligned</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> 
                        <span class="n">bin_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> 
                        <span class="n">lower_limit_on_fit</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">800.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute displacement, coherence, and related uncertainties for binned time series data.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - profile1_unaligned (xr.DataArray): Unaligned time series data for the first measurement.</span>
<span class="sd">    - profile2_unaligned (xr.DataArray): Unaligned time series data for the second measurement.</span>
<span class="sd">    - bin_size (int, optional): Size of the vertical bins. Default is 20.</span>

<span class="sd">    Returns:</span>
<span class="sd">    xr.Dataset: Timeseries of profiles of coherence, phase, displacement, and associated uncertainties, binned in depth.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">profiles</span> <span class="o">=</span> <span class="n">combine_profiles</span><span class="p">(</span><span class="n">profile1_unaligned</span><span class="p">,</span> <span class="n">profile2_unaligned</span><span class="p">)</span>

    <span class="n">profiles_binned</span> <span class="o">=</span> <span class="n">bin_profiles</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">)</span>

    <span class="n">coherence</span> <span class="o">=</span> <span class="n">compute_coherence</span><span class="p">(</span><span class="n">profiles_binned</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">shot_number</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">profiles_binned</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">shot_number</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
   
    <span class="c1"># add attributes related to the bin_depth</span>
    <span class="n">coherence</span><span class="o">.</span><span class="n">bin_depth</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span>
    <span class="n">coherence</span><span class="o">.</span><span class="n">bin_depth</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;depth to the center of each bin&quot;</span>
    <span class="n">coherence</span><span class="o">.</span><span class="n">bin_depth</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;standard_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bin depth&quot;</span>         

    <span class="c1"># add attributes related to the coherence</span>
    <span class="n">coherence</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unitless&quot;</span>
    <span class="n">coherence</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;complex coherence between measurements&quot;</span>

    <span class="c1"># compute the phase and add attributes</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="o">-</span><span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">,</span> <span class="n">coherence</span><span class="p">,</span> <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;allowed&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;phase&quot;</span><span class="p">)</span>
    <span class="n">phase</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;radians&quot;</span>
    <span class="n">phase</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;coherence phase&quot;</span>

    <span class="c1"># compute phase uncertainties</span>
    <span class="n">phase_uncertainty</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">coherence</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">1.</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">coherence</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">bin_size</span><span class="p">)))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;phase_uncertainty&#39;</span><span class="p">)</span>
    <span class="n">phase_uncertainty</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;radians&quot;</span>
    <span class="n">phase_uncertainty</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;uncertainty in coherence phase&quot;</span>

    <span class="c1"># compute the displacement</span>
    <span class="n">displacement</span> <span class="o">=</span> <span class="n">phase2range</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;displacement&quot;</span><span class="p">)</span>
    <span class="n">displacement</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span>
    <span class="n">displacement</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;displacement since previous measurement&quot;</span>

    <span class="c1"># compute the displacement uncertainty</span>
    <span class="n">disp_uncertainty</span> <span class="o">=</span> <span class="n">phase2range</span><span class="p">(</span><span class="n">phase_uncertainty</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;disp_uncertainty&#39;</span><span class="p">)</span>
    <span class="n">disp_uncertainty</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span>
    <span class="n">disp_uncertainty</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;uncertainty in displacement since previous measurement&quot;</span>

    <span class="n">dt_years</span> <span class="o">=</span> <span class="p">((</span><span class="n">profiles</span><span class="o">.</span><span class="n">profile_time</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">shot_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">profiles</span><span class="o">.</span><span class="n">profile_time</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">shot_number</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">365.25</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;dt_years&#39;</span><span class="p">)</span>
    <span class="n">dt_years</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;years&#39;</span>
    <span class="n">dt_years</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Time between shots&#39;</span>
    <span class="n">dt_years</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Time in years between shots used in each measurement of displacement, vertical velocity, etc. dt_years[i] is the time between shot [j] and shot [j-1]&#39;</span>

    <span class="c1"># vertical velocity</span>
    <span class="n">velocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">displacement</span> <span class="o">/</span> <span class="n">dt_years</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;velocity&#39;</span><span class="p">)</span>
    <span class="n">velocity</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;meters/year&#39;</span>
    <span class="n">velocity</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Vertical velocity&#39;</span>

    <span class="c1"># strain rates</span>
    <span class="n">strain_rates</span> <span class="o">=</span> <span class="n">velocity</span><span class="o">.</span><span class="n">computeStrainRates</span><span class="p">(</span><span class="n">lower_limit_on_fit</span> <span class="o">=</span> <span class="n">lower_limit_on_fit</span><span class="p">)</span>

    <span class="c1"># combine to an xarray dataset</span>
    <span class="n">da_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">profiles</span><span class="p">,</span> <span class="n">coherence</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">phase_uncertainty</span><span class="p">,</span> <span class="n">displacement</span><span class="p">,</span> <span class="n">disp_uncertainty</span><span class="p">,</span> <span class="n">velocity</span><span class="p">,</span> <span class="n">strain_rates</span><span class="p">]</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">da_list</span><span class="p">)</span>

    <span class="c1"># add attributes related to this processing</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;bin_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_size</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Time series of profiles of coherence, phase, displacement, and associated uncertainties, binned in depth.&quot;</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;processing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Created by the compute_displacement function in xapres using a bin size of </span><span class="si">{</span><span class="n">bin_size</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">ds</span>

<span class="k">def</span> <span class="nf">combine_profiles</span><span class="p">(</span><span class="n">profile1_unaligned</span><span class="p">,</span> <span class="n">profile2_unaligned</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Combine two timeseries of profiles. In the case of unattended data, record the midpoint time and the time of each computed profile&quot;&quot;&quot;</span>
    
<span class="c1"># in the case when we selected the time step with .isel(time=N), where N is an integer, we dont have time as a dimension. THe following accounts for this scenario</span>
    <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">profile1_unaligned</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">profile1_unaligned</span> <span class="o">=</span> <span class="n">profile1_unaligned</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">profile2_unaligned</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">profile2_unaligned</span> <span class="o">=</span> <span class="n">profile2_unaligned</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>


    <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">profile1_unaligned</span><span class="o">.</span><span class="n">dims</span> <span class="ow">and</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">profile1_unaligned</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
        <span class="c1"># data is taken in attended mode and we dont need to get the midpoint time and align</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">profile1_unaligned</span><span class="p">,</span> <span class="n">profile2_unaligned</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;shot_number&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>

        
        <span class="c1"># record the time interval between measurements</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">profile1_unaligned</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">profile2_unaligned</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">t2</span><span class="o">-</span><span class="n">t1</span>

        <span class="c1"># change the name of the time coordinates so that they can be retained when the profiles are concatenated, then drop the original &#39;time&#39; coordinates (the latter is achieved with drop_vars)</span>
        <span class="n">profile1_unaligned</span> <span class="o">=</span> <span class="n">profile1_unaligned</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">profile_time</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">profile1_unaligned</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span><span class="p">))</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="n">profile2_unaligned</span> <span class="o">=</span> <span class="n">profile2_unaligned</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">profile_time</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">profile2_unaligned</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span><span class="p">))</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

        <span class="c1"># concatenate the two profiles</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">profile1_unaligned</span><span class="p">,</span> <span class="n">profile2_unaligned</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;shot_number&#39;</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;profile_time&#39;</span><span class="p">,</span> <span class="s1">&#39;burst_number&#39;</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">])</span>

        <span class="c1"># add the midpoint time </span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="o">+</span><span class="n">dt</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">profiles</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mid-point time of two profiles used in the computation&quot;</span>

    <span class="n">profiles</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">shot_number</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;shot_number&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">profiles</span><span class="o">.</span><span class="n">shot_number</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
    <span class="n">profiles</span><span class="o">.</span><span class="n">shot_number</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;shot number&#39;</span>
    <span class="n">profiles</span><span class="o">.</span><span class="n">shot_number</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;number of the shot used in each measurement&#39;</span>


    <span class="k">return</span> <span class="n">profiles</span>

<span class="k">def</span> <span class="nf">bin_profiles</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Put the time series into vertical bins&quot;&quot;&quot;</span>
    
    <span class="c1"># Bin in depth</span>
    <span class="n">profiles_binned</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">coarsen</span><span class="p">(</span><span class="n">profile_range</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;trim&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="n">profile_range</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;bin_depth&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_in_bin&quot;</span><span class="p">))</span>

    <span class="c1"># Compute the bin depth and add it to the DataArray</span>
    <span class="n">bin_depth</span> <span class="o">=</span> <span class="n">profiles_binned</span><span class="o">.</span><span class="n">profile_range</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;sample_in_bin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
    <span class="n">profiles_binned</span> <span class="o">=</span> <span class="n">profiles_binned</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">bin_depth</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;bin_depth&quot;</span><span class="p">,</span> <span class="n">bin_depth</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">profiles_binned</span>

<span class="k">def</span> <span class="nf">compute_coherence</span><span class="p">(</span><span class="n">b1_binned</span><span class="p">,</span> <span class="n">b2_binned</span><span class="p">):</span>
    <span class="c1"># compute the coherence</span>
    <span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="n">b1_binned</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">b2_binned</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;sample_in_bin&quot;</span><span class="p">)</span>
    <span class="n">bottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_binned</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;sample_in_bin&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b2_binned</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;sample_in_bin&quot;</span><span class="p">))</span>
    <span class="n">coherence</span> <span class="o">=</span> <span class="p">(</span><span class="n">top</span><span class="o">/</span><span class="n">bottom</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;coherence&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">top</span><span class="o">/</span><span class="n">bottom</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;coherence&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">phase2range</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> 
                <span class="n">lambdac</span><span class="o">=</span><span class="mf">0.5608</span><span class="p">,</span> 
                <span class="n">rc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                <span class="n">K</span><span class="o">=</span><span class="mf">2e8</span><span class="p">,</span> 
                <span class="n">ci</span><span class="o">=</span><span class="mf">1.6823e8</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert phase difference to range for FMCW radar</span>
<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        lambdac: float</span>
<span class="sd">            wavelength (m) at center frequency</span>
<span class="sd">        rc: float; optional</span>
<span class="sd">            coarse range of bin center (m)</span>
<span class="sd">        K:  float; optional</span>
<span class="sd">            chirp gradient (rad/s/s)</span>
<span class="sd">        ci: float; optional</span>
<span class="sd">            propagation velocity (m/s)</span>
<span class="sd">        ### Original Matlab File Notes ###</span>
<span class="sd">        Craig Stewart</span>
<span class="sd">        2014/6/10</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">K</span><span class="p">,</span><span class="n">ci</span><span class="p">])</span> <span class="ow">or</span> <span class="n">rc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># First order method</span>
            <span class="c1"># Brennan et al. (2014) eq 15</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">lambdac</span><span class="o">*</span><span class="n">phi</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Precise</span>
            <span class="c1"># Appears to be from Stewart (2018) eqn 4.8, with tau = 2*R/ci and omega_c = 2 pi /lambdac, where R is the range</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">phi</span><span class="o">/</span><span class="p">((</span><span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">lambdac</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">rc</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span><span class="o">*</span><span class="n">K</span><span class="o">/</span><span class="n">ci</span><span class="o">**</span><span class="mf">2.</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">computeStrainRates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lower_limit_on_fit</span> <span class="o">=</span> <span class="mi">800</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute strain rates from a dataset of ApRES data. For use by the function `compute_displacement`&quot;&quot;&quot;</span>
    <span class="n">velocity_cropped</span> <span class="o">=</span> <span class="bp">self</span>\
            <span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>\
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_depth</span> <span class="o">&lt;</span> <span class="n">lower_limit_on_fit</span><span class="p">)</span>
    
    <span class="n">fit_ds</span> <span class="o">=</span> <span class="n">velocity_cropped</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="s1">&#39;bin_depth&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">full</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            
    <span class="n">strain_rate</span> <span class="o">=</span> <span class="n">fit_ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">degree</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">polyfit_coefficients</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;strain_rate&#39;</span><span class="p">)</span>

    <span class="n">surface_intercept</span> <span class="o">=</span>  <span class="n">fit_ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">degree</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">polyfit_coefficients</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;surface_intercept&#39;</span><span class="p">)</span> 

    <span class="c1"># R^2</span>
    <span class="n">y_mean</span> <span class="o">=</span> <span class="n">velocity_cropped</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;bin_depth&#39;</span><span class="p">)</span>
    <span class="n">SS_tot</span> <span class="o">=</span> <span class="p">((</span><span class="n">velocity_cropped</span> <span class="o">-</span> <span class="n">y_mean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;bin_depth&#39;</span><span class="p">)</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">fit_ds</span><span class="o">.</span><span class="n">polyfit_residuals</span><span class="o">/</span><span class="n">SS_tot</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;r_squared&#39;</span><span class="p">)</span>

    <span class="c1"># add attrs</span>
    <span class="n">strain_rate</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1/year&#39;</span>
    <span class="n">strain_rate</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;vertical strain rate in upper </span><span class="si">{</span><span class="n">lower_limit_on_fit</span><span class="si">}</span><span class="s2"> m&quot;</span>
    <span class="n">strain_rate</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;lower_limit_on_fit_meters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower_limit_on_fit</span>

    <span class="n">surface_intercept</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;meters/year&#39;</span>
    <span class="n">surface_intercept</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;vertical velocity at the surface from the linear fit&#39;</span>
    <span class="n">surface_intercept</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;lower_limit_on_fit_meters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower_limit_on_fit</span>
    
    <span class="n">R2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;r-squared value for the linear fit&#39;</span>
    <span class="n">R2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> 
    
    <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">strain_rate</span><span class="p">,</span> <span class="n">surface_intercept</span><span class="p">,</span> <span class="n">R2</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">dB</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function to convert profile data to decibels.</span>
<span class="sd">    </span>
<span class="sd">    The function is added to xarray dataarrays as a bound method in two functions. </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> 

<span class="k">def</span> <span class="nf">sonify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
           <span class="n">play</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
           <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
           <span class="n">wav_filename</span><span class="o">=</span><span class="s2">&quot;chirp&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function to sonify a chirp - play the signal as a sound.</span>
<span class="sd">     </span>
<span class="sd">    The function is added to xarray dataarrays as a bound method in two functions. </span>
<span class="sd">    </span>
<span class="sd">    It requires soundfile and sounddevice to be installed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>     
        <span class="kn">import</span> <span class="nn">soundfile</span> <span class="k">as</span> <span class="nn">sf</span>
        <span class="kn">import</span> <span class="nn">sounddevice</span> <span class="k">as</span> <span class="nn">sd</span> 
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sounddevice and soundfile are required to sonify the chirps. pip install them if you need this feature&quot;</span><span class="p">)</span> 

    <span class="c1"># make sure the input is just one chirp    </span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">size</span><span class="p">:</span> 
        <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="s1">&#39;sonify only works for single chirps.&#39;</span><span class="p">)</span>    

    <span class="c1"># subset the chirp to remove popping</span>
    <span class="n">chirp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">chirp_time</span> <span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span><span class="o">-</span><span class="mi">500</span><span class="p">))</span>

    <span class="c1"># convert to a numpy array and remove singleton dimensions</span>
    <span class="n">chirp_values</span> <span class="o">=</span> <span class="n">chirp</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">chirp</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># convert the start and end time of the subsetted chirp to seconds, dealing with the cases when chirp.chirp_time is numpy array and when it is a timeselta64</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">startTimeInSeconds</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">endTimeInSeconds</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">):</span>
        <span class="n">startTimeInSeconds</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>
        <span class="n">endTimeInSeconds</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>

    <span class="c1"># calculate the sample rate </span>
    <span class="n">samplerate</span> <span class="o">=</span> <span class="n">chirp</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="n">endTimeInSeconds</span> <span class="o">-</span> <span class="n">startTimeInSeconds</span><span class="p">)</span>
    <span class="n">samplerate</span> <span class="o">=</span> <span class="n">samplerate</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">play</span><span class="p">:</span>
        <span class="n">sd</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">chirp_values</span><span class="p">,</span> <span class="n">samplerate</span><span class="o">=</span><span class="n">samplerate</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">wav_filename</span><span class="si">}</span><span class="s2"> .wav&quot;</span><span class="p">,</span> <span class="n">chirp_values</span><span class="p">,</span> <span class="n">samplerate</span><span class="o">=</span><span class="n">samplerate</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">addProfileToDs</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    
    <span class="k">if</span> <span class="s1">&#39;constants&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chirp</span><span class="o">.</span><span class="n">computeProfile</span><span class="p">(</span><span class="n">constants</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chirp</span><span class="o">.</span><span class="n">computeProfile</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># remove profile variable and profile range, if they exist </span>
    <span class="k">if</span> <span class="s1">&#39;profile&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_dims</span><span class="p">(</span><span class="s1">&#39;profile_range&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span>

        
    <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">out</span><span class="p">,</span> <span class="n">profile</span><span class="p">],</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="s1">&#39;override&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">computeProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
                   <span class="n">pad_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                   <span class="n">drop_noisy_chirps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">clip_threshold</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
                   <span class="n">min_chirps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">demean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">stack</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">scale_for_window</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">crop_chirp_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">crop_chirp_end</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">max_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">constants</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute profiles from chirp data.</span>
<span class="sd">    -----------</span>
<span class="sd">    self : xr.DataArray</span>
<span class="sd">        The input chirp data array.</span>
<span class="sd">    pad_factor : int, optional</span>
<span class="sd">        Factor by which to pad the chirp data (default is 2).</span>
<span class="sd">    drop_noisy_chirps : bool, optional</span>
<span class="sd">        Whether to drop noisy chirps (default is False).</span>
<span class="sd">    clip_threshold : float, optional</span>
<span class="sd">        Threshold for clipping noisy chirps (default is 1.2).</span>
<span class="sd">    min_chirps : int, optional</span>
<span class="sd">        Minimum number of chirps required to keep a burst (default is 20).</span>
<span class="sd">    demean : bool, optional</span>
<span class="sd">        Whether to demean the chirp data (default is False).</span>
<span class="sd">    detrend : bool, optional</span>
<span class="sd">        Whether to detrend the chirp data (default is False).</span>
<span class="sd">    stack : bool, optional</span>
<span class="sd">        Whether to stack the chirp data (default is False).</span>
<span class="sd">    scale_for_window : bool, optional</span>
<span class="sd">        Whether to scale the chirp data for the window (default is True).</span>
<span class="sd">        This is only an option to allow tests to effectively compare the output of </span>
<span class="sd">        this function with the output of the legacy fft method.</span>
<span class="sd">    crop_chirp_start : float, optional</span>
<span class="sd">        Start time for cropping chirps in seconds (default is 0, the start of the chirp).</span>
<span class="sd">    crop_chirp_end : float, optional</span>
<span class="sd">        End time for cropping chirps in seconds (default is 1, the end f the chirp).</span>
<span class="sd">    max_range : float, optional</span>
<span class="sd">        Maximum range for the profile in meters (default is None).</span>
<span class="sd">    constants : dict, optional</span>
<span class="sd">        Dictionary of user-defined constants for the radar system. </span>
<span class="sd">        Any constants that are not supplied in constants are defined in default_constants()</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    xr.DataArray</span>
<span class="sd">        The computed radar profile with range as the coordinate.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">constants</span> <span class="o">=</span> <span class="n">default_constants</span><span class="p">()</span> <span class="o">|</span> <span class="n">constants</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span>       <span class="c1"># bandwidth [Hz]</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span>       <span class="c1"># rate of chnge of frequency [Hz/s]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>       <span class="c1"># speed of light in a vacuum [m/s]</span>
    <span class="n">ep</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;ep&#39;</span><span class="p">]</span>     <span class="c1"># permittivity of ice</span>
    <span class="n">f_c</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;f_c&#39;</span><span class="p">]</span>   <span class="c1"># center frequency [Hz]</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>     <span class="c1"># time step [s]</span>

    <span class="k">def</span> <span class="nf">rdei</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;round down to the nearest even integer and return an integer&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">freq2range</span><span class="p">(</span><span class="n">frequencies</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;return the range for a given frequency&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">c</span> <span class="o">*</span> <span class="n">frequencies</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span><span class="o">*</span><span class="n">K</span><span class="p">)</span>

    <span class="n">Nt</span> <span class="o">=</span> <span class="n">rdei</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>   
    <span class="n">chirps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">chirp_time</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nt</span><span class="p">))</span>
    
    <span class="n">sampling_frequency</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dt</span> 

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">chirps</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">):</span>
        <span class="n">chirps</span><span class="p">[</span><span class="s1">&#39;chirp_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chirps</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span><span class="o">/</span><span class="mf">1e9</span>

    <span class="c1"># if crop_chirp_start is not None:</span>
    <span class="n">chirps</span> <span class="o">=</span> <span class="n">chirps</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">chirp_time</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">crop_chirp_start</span><span class="p">,</span> <span class="n">crop_chirp_end</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">drop_noisy_chirps</span><span class="p">:</span>
        <span class="n">bad_chirps</span> <span class="o">=</span>  <span class="n">chirps</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">chirps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">clip_threshold</span><span class="p">)</span>
        <span class="n">good_bursts</span> <span class="o">=</span> <span class="n">bad_chirps</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;chirp_time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;chirp_num&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_chirps</span>
        <span class="n">chirps</span> <span class="o">=</span> <span class="n">chirps</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_bursts</span><span class="p">)</span>
        <span class="n">chirps</span> <span class="o">=</span> <span class="n">chirps</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">chirps</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;chirp_time&#39;</span><span class="p">)</span><span class="o">&lt;</span><span class="n">clip_threshold</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">demean</span><span class="p">:</span>
        <span class="n">chirps</span> <span class="o">=</span> <span class="n">chirps</span> <span class="o">-</span> <span class="n">chirps</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;chirp_time&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">detrend</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">chirps</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="s1">&#39;chirp_time&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">chirps</span><span class="o">.</span><span class="n">chirp_time</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">polyfit_coefficients</span><span class="p">)</span>
        <span class="n">chirps</span> <span class="o">=</span> <span class="n">chirps</span> <span class="o">-</span> <span class="n">fit</span>

    <span class="k">if</span> <span class="n">stack</span><span class="p">:</span>   
        <span class="n">chirps</span> <span class="o">=</span> <span class="n">chirps</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;chirp_num&#39;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># note on variable naming below: s stands for the pre-fft signal, following others&#39; notation, w stands for windowed, p stands for padding, and so on</span>
   
    <span class="c1"># window</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">blackman</span><span class="p">(</span><span class="n">chirps</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dims</span> <span class="o">=</span> <span class="s1">&#39;chirp_time&#39;</span><span class="p">)</span>
    <span class="n">s_w</span> <span class="o">=</span> <span class="n">chirps</span> <span class="o">*</span> <span class="n">window</span>  
    
    <span class="c1"># pad</span>
    <span class="n">s_wp</span> <span class="o">=</span> <span class="n">s_w</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">chirp_time</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">Nt</span><span class="o">*</span><span class="n">pad_factor</span><span class="o">-</span><span class="n">Nt</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  

    <span class="c1"># roll</span>
    <span class="n">s_wpr</span> <span class="o">=</span> <span class="n">s_wp</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">chirp_time</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">Nt</span><span class="o">*</span><span class="n">pad_factor</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>  

    <span class="k">if</span> <span class="n">contains_dask_array</span><span class="p">(</span><span class="n">s_wpr</span><span class="p">):</span>
        <span class="n">s_wpr</span> <span class="o">=</span> <span class="n">s_wpr</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;chirp_time&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">})</span>

    <span class="c1"># fft</span>
    <span class="n">S_wpr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">,</span> 
                        <span class="n">s_wpr</span><span class="p">,</span>
                        <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;chirp_time&quot;</span><span class="p">]],</span>
                        <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;chirp_time&quot;</span><span class="p">]])</span>
    
    <span class="c1"># scale for padding</span>
    <span class="n">S_wpr</span> <span class="o">=</span> <span class="n">S_wpr</span><span class="o">/</span><span class="n">s_wpr</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pad_factor</span><span class="p">)</span> 
    
    <span class="k">if</span> <span class="n">scale_for_window</span><span class="p">:</span>
        <span class="n">S_wpr</span> <span class="o">=</span> <span class="n">S_wpr</span><span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">blackman</span><span class="p">(</span><span class="n">Nt</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># scale for window</span>
    
    <span class="c1"># compute range</span>
    <span class="n">indexes</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s_wpr</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> 
    <span class="n">frequencies</span>  <span class="o">=</span> <span class="n">indexes</span> <span class="o">*</span> <span class="n">sampling_frequency</span><span class="o">/</span><span class="n">s_wpr</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">size</span>
    <span class="n">profile_range</span> <span class="o">=</span> <span class="n">freq2range</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span>

    <span class="c1"># reference array</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">S_wpr</span><span class="o">.</span><span class="n">chirp_time</span><span class="p">))</span><span class="o">/</span><span class="n">pad_factor</span>
    <span class="n">phiref</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">f_c</span><span class="o">*</span><span class="n">m</span><span class="o">/</span><span class="n">B</span> <span class="o">-</span>  <span class="n">m</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">K</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">B</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">S_wprr</span> <span class="o">=</span> <span class="n">S_wpr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">phiref</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">))</span>
    <span class="n">S_wprr</span> <span class="o">=</span> <span class="n">S_wprr</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">)</span>
    <span class="n">S_wprr</span> <span class="o">=</span> <span class="n">S_wprr</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;chirp_time&#39;</span><span class="p">:</span> <span class="s1">&#39;profile_range&#39;</span><span class="p">})</span>
    <span class="n">S_wprr</span><span class="p">[</span><span class="s1">&#39;profile_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile_range</span>

    <span class="c1"># crop to max_range</span>
    <span class="k">if</span> <span class="n">max_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_range</span> <span class="o">=</span> <span class="n">S_wprr</span><span class="o">.</span><span class="n">profile_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">S_wprr</span> <span class="o">=</span> <span class="n">S_wprr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">profile_range</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">S_wprr</span><span class="o">.</span><span class="n">profile_range</span><span class="o">.</span><span class="n">size</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">S_wprr</span> <span class="o">=</span> <span class="n">S_wprr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">S_wprr</span><span class="o">.</span><span class="n">profile_range</span> <span class="o">&lt;=</span> <span class="n">max_range</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># add attributes</span>
    <span class="n">S_wprr</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;profile&#39;</span> 
    <span class="n">S_wprr</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
    <span class="n">S_wprr</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;complex profile computed from the fourier transform of the de-ramped chirp&#39;</span>
    <span class="n">S_wprr</span><span class="o">.</span><span class="n">profile_range</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;depth&#39;</span>
    <span class="n">S_wprr</span><span class="o">.</span><span class="n">profile_range</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;meters&#39;</span>
    <span class="n">S_wprr</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constants</span>

    <span class="k">return</span> <span class="n">S_wprr</span>

<span class="k">def</span> <span class="nf">default_constants</span><span class="p">():</span>
    <span class="n">constants</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>               <span class="c1"># chirp duration [s]</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;f_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">200e6</span>         <span class="c1"># starting frequency [Hz]</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;f_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">400e6</span>         <span class="c1"># ending frequency [Hz]</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;f_2&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">constants</span><span class="p">[</span><span class="s1">&#39;f_1&#39;</span><span class="p">]</span>          <span class="c1"># bandwidth [Hz]</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">constants</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>            <span class="c1"># rate of chnge of frequency [Hz/s]</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">300000000.0</span>     <span class="c1"># speed of light in a vacuum [m/s]</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;ep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.18</span>           <span class="c1"># permittivity of ice</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;f_c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="s1">&#39;f_2&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">constants</span><span class="p">[</span><span class="s1">&#39;f_1&#39;</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>   <span class="c1"># center frequency [Hz]</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">40000</span>        <span class="c1"># time step [s]</span>

    <span class="k">return</span> <span class="n">constants</span>
    
<span class="k">def</span> <span class="nf">add_methods_to_xarrays</span><span class="p">():</span>
    
    <span class="n">da_methods</span> <span class="o">=</span> <span class="p">[</span><span class="n">dB</span><span class="p">,</span> <span class="n">sonify</span><span class="p">,</span> <span class="n">displacement_timeseries</span><span class="p">,</span> <span class="n">computeProfile</span><span class="p">,</span> <span class="n">computeStrainRates</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">da_methods</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

    <span class="n">ds_methods</span> <span class="o">=</span> <span class="p">[</span><span class="n">addProfileToDs</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">ds_methods</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">contains_dask_array</span><span class="p">(</span><span class="n">dataarray</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataarray</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">)</span>
</pre></div>

  </div>

  </header>

  <section id="section-items">

    <h2 class="section-title" id="header-functions">Functions</h2>
      
  <div class="item">
    <div class="name def" id="utils.addProfileToDs">
    <p>def <span class="ident">addProfileToDs</span>(</p><p>self: xarray.core.dataset.Dataset, **kwargs)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-utils.addProfileToDs', this);">Show source &equiv;</a></p>
  <div id="source-utils.addProfileToDs" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">addProfileToDs</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    
    <span class="k">if</span> <span class="s1">&#39;constants&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chirp</span><span class="o">.</span><span class="n">computeProfile</span><span class="p">(</span><span class="n">constants</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chirp</span><span class="o">.</span><span class="n">computeProfile</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># remove profile variable and profile range, if they exist </span>
    <span class="k">if</span> <span class="s1">&#39;profile&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_dims</span><span class="p">(</span><span class="s1">&#39;profile_range&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span>

        
    <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">out</span><span class="p">,</span> <span class="n">profile</span><span class="p">],</span> <span class="n">combine_attrs</span><span class="o">=</span><span class="s1">&#39;override&#39;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="utils.add_methods_to_xarrays">
    <p>def <span class="ident">add_methods_to_xarrays</span>(</p><p>)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-utils.add_methods_to_xarrays', this);">Show source &equiv;</a></p>
  <div id="source-utils.add_methods_to_xarrays" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">add_methods_to_xarrays</span><span class="p">():</span>
    
    <span class="n">da_methods</span> <span class="o">=</span> <span class="p">[</span><span class="n">dB</span><span class="p">,</span> <span class="n">sonify</span><span class="p">,</span> <span class="n">displacement_timeseries</span><span class="p">,</span> <span class="n">computeProfile</span><span class="p">,</span> <span class="n">computeStrainRates</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">da_methods</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

    <span class="n">ds_methods</span> <span class="o">=</span> <span class="p">[</span><span class="n">addProfileToDs</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">ds_methods</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="utils.bin_profiles">
    <p>def <span class="ident">bin_profiles</span>(</p><p>profiles, bin_size)</p>
    </div>
    

    
  
    <div class="desc"><p>Put the time series into vertical bins</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-utils.bin_profiles', this);">Show source &equiv;</a></p>
  <div id="source-utils.bin_profiles" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">bin_profiles</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Put the time series into vertical bins&quot;&quot;&quot;</span>
    
    <span class="c1"># Bin in depth</span>
    <span class="n">profiles_binned</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">coarsen</span><span class="p">(</span><span class="n">profile_range</span><span class="o">=</span><span class="n">bin_size</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;trim&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="n">profile_range</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;bin_depth&quot;</span><span class="p">,</span> <span class="s2">&quot;sample_in_bin&quot;</span><span class="p">))</span>

    <span class="c1"># Compute the bin depth and add it to the DataArray</span>
    <span class="n">bin_depth</span> <span class="o">=</span> <span class="n">profiles_binned</span><span class="o">.</span><span class="n">profile_range</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;sample_in_bin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
    <span class="n">profiles_binned</span> <span class="o">=</span> <span class="n">profiles_binned</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">bin_depth</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;bin_depth&quot;</span><span class="p">,</span> <span class="n">bin_depth</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">profiles_binned</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="utils.combine_profiles">
    <p>def <span class="ident">combine_profiles</span>(</p><p>profile1_unaligned, profile2_unaligned)</p>
    </div>
    

    
  
    <div class="desc"><p>Combine two timeseries of profiles. In the case of unattended data, record the midpoint time and the time of each computed profile</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-utils.combine_profiles', this);">Show source &equiv;</a></p>
  <div id="source-utils.combine_profiles" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">combine_profiles</span><span class="p">(</span><span class="n">profile1_unaligned</span><span class="p">,</span> <span class="n">profile2_unaligned</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Combine two timeseries of profiles. In the case of unattended data, record the midpoint time and the time of each computed profile&quot;&quot;&quot;</span>
    
<span class="c1"># in the case when we selected the time step with .isel(time=N), where N is an integer, we dont have time as a dimension. THe following accounts for this scenario</span>
    <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">profile1_unaligned</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">profile1_unaligned</span> <span class="o">=</span> <span class="n">profile1_unaligned</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">profile2_unaligned</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">profile2_unaligned</span> <span class="o">=</span> <span class="n">profile2_unaligned</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>


    <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">profile1_unaligned</span><span class="o">.</span><span class="n">dims</span> <span class="ow">and</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">profile1_unaligned</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
        <span class="c1"># data is taken in attended mode and we dont need to get the midpoint time and align</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">profile1_unaligned</span><span class="p">,</span> <span class="n">profile2_unaligned</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;shot_number&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>

        
        <span class="c1"># record the time interval between measurements</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">profile1_unaligned</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">profile2_unaligned</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">t2</span><span class="o">-</span><span class="n">t1</span>

        <span class="c1"># change the name of the time coordinates so that they can be retained when the profiles are concatenated, then drop the original &#39;time&#39; coordinates (the latter is achieved with drop_vars)</span>
        <span class="n">profile1_unaligned</span> <span class="o">=</span> <span class="n">profile1_unaligned</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">profile_time</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">profile1_unaligned</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span><span class="p">))</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="n">profile2_unaligned</span> <span class="o">=</span> <span class="n">profile2_unaligned</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">profile_time</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">profile2_unaligned</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span><span class="p">))</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

        <span class="c1"># concatenate the two profiles</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">profile1_unaligned</span><span class="p">,</span> <span class="n">profile2_unaligned</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;shot_number&#39;</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;profile_time&#39;</span><span class="p">,</span> <span class="s1">&#39;burst_number&#39;</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">])</span>

        <span class="c1"># add the midpoint time </span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="o">+</span><span class="n">dt</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">profiles</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mid-point time of two profiles used in the computation&quot;</span>

    <span class="n">profiles</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">shot_number</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;shot_number&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">profiles</span><span class="o">.</span><span class="n">shot_number</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
    <span class="n">profiles</span><span class="o">.</span><span class="n">shot_number</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;shot number&#39;</span>
    <span class="n">profiles</span><span class="o">.</span><span class="n">shot_number</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;number of the shot used in each measurement&#39;</span>


    <span class="k">return</span> <span class="n">profiles</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="utils.computeProfile">
    <p>def <span class="ident">computeProfile</span>(</p><p>self: xarray.core.dataarray.DataArray, pad_factor=2, drop_noisy_chirps=False, clip_threshold=1.2, min_chirps=0, demean=True, detrend=False, stack=False, scale_for_window=True, crop_chirp_start=0, crop_chirp_end=1, max_range=None, constants={})</p>
    </div>
    

    
  
    <div class="desc"><h2 id="compute-profiles-from-chirp-data">Compute profiles from chirp data.</h2>
<p>self : xr.DataArray
    The input chirp data array.
pad_factor : int, optional
    Factor by which to pad the chirp data (default is 2).
drop_noisy_chirps : bool, optional
    Whether to drop noisy chirps (default is False).
clip_threshold : float, optional
    Threshold for clipping noisy chirps (default is 1.2).
min_chirps : int, optional
    Minimum number of chirps required to keep a burst (default is 20).
demean : bool, optional
    Whether to demean the chirp data (default is False).
detrend : bool, optional
    Whether to detrend the chirp data (default is False).
stack : bool, optional
    Whether to stack the chirp data (default is False).
scale_for_window : bool, optional
    Whether to scale the chirp data for the window (default is True).
    This is only an option to allow tests to effectively compare the output of 
    this function with the output of the legacy fft method.
crop_chirp_start : float, optional
    Start time for cropping chirps in seconds (default is 0, the start of the chirp).
crop_chirp_end : float, optional
    End time for cropping chirps in seconds (default is 1, the end f the chirp).
max_range : float, optional
    Maximum range for the profile in meters (default is None).
constants : dict, optional
    Dictionary of user-defined constants for the radar system. 
    Any constants that are not supplied in constants are defined in default_constants()</p>
<h2 id="returns">Returns:</h2>
<p>xr.DataArray
    The computed radar profile with range as the coordinate.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-utils.computeProfile', this);">Show source &equiv;</a></p>
  <div id="source-utils.computeProfile" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">computeProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
                   <span class="n">pad_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                   <span class="n">drop_noisy_chirps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">clip_threshold</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>
                   <span class="n">min_chirps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">demean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">stack</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">scale_for_window</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">crop_chirp_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">crop_chirp_end</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">max_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">constants</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute profiles from chirp data.</span>
<span class="sd">    -----------</span>
<span class="sd">    self : xr.DataArray</span>
<span class="sd">        The input chirp data array.</span>
<span class="sd">    pad_factor : int, optional</span>
<span class="sd">        Factor by which to pad the chirp data (default is 2).</span>
<span class="sd">    drop_noisy_chirps : bool, optional</span>
<span class="sd">        Whether to drop noisy chirps (default is False).</span>
<span class="sd">    clip_threshold : float, optional</span>
<span class="sd">        Threshold for clipping noisy chirps (default is 1.2).</span>
<span class="sd">    min_chirps : int, optional</span>
<span class="sd">        Minimum number of chirps required to keep a burst (default is 20).</span>
<span class="sd">    demean : bool, optional</span>
<span class="sd">        Whether to demean the chirp data (default is False).</span>
<span class="sd">    detrend : bool, optional</span>
<span class="sd">        Whether to detrend the chirp data (default is False).</span>
<span class="sd">    stack : bool, optional</span>
<span class="sd">        Whether to stack the chirp data (default is False).</span>
<span class="sd">    scale_for_window : bool, optional</span>
<span class="sd">        Whether to scale the chirp data for the window (default is True).</span>
<span class="sd">        This is only an option to allow tests to effectively compare the output of </span>
<span class="sd">        this function with the output of the legacy fft method.</span>
<span class="sd">    crop_chirp_start : float, optional</span>
<span class="sd">        Start time for cropping chirps in seconds (default is 0, the start of the chirp).</span>
<span class="sd">    crop_chirp_end : float, optional</span>
<span class="sd">        End time for cropping chirps in seconds (default is 1, the end f the chirp).</span>
<span class="sd">    max_range : float, optional</span>
<span class="sd">        Maximum range for the profile in meters (default is None).</span>
<span class="sd">    constants : dict, optional</span>
<span class="sd">        Dictionary of user-defined constants for the radar system. </span>
<span class="sd">        Any constants that are not supplied in constants are defined in default_constants()</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    xr.DataArray</span>
<span class="sd">        The computed radar profile with range as the coordinate.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">constants</span> <span class="o">=</span> <span class="n">default_constants</span><span class="p">()</span> <span class="o">|</span> <span class="n">constants</span>

    <span class="n">B</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span>       <span class="c1"># bandwidth [Hz]</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span>       <span class="c1"># rate of chnge of frequency [Hz/s]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>       <span class="c1"># speed of light in a vacuum [m/s]</span>
    <span class="n">ep</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;ep&#39;</span><span class="p">]</span>     <span class="c1"># permittivity of ice</span>
    <span class="n">f_c</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;f_c&#39;</span><span class="p">]</span>   <span class="c1"># center frequency [Hz]</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>     <span class="c1"># time step [s]</span>

    <span class="k">def</span> <span class="nf">rdei</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;round down to the nearest even integer and return an integer&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">freq2range</span><span class="p">(</span><span class="n">frequencies</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;return the range for a given frequency&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">c</span> <span class="o">*</span> <span class="n">frequencies</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span><span class="o">*</span><span class="n">K</span><span class="p">)</span>

    <span class="n">Nt</span> <span class="o">=</span> <span class="n">rdei</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>   
    <span class="n">chirps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">chirp_time</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nt</span><span class="p">))</span>
    
    <span class="n">sampling_frequency</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dt</span> 

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">chirps</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="s1">&#39;float64&#39;</span><span class="p">):</span>
        <span class="n">chirps</span><span class="p">[</span><span class="s1">&#39;chirp_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chirps</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span><span class="o">/</span><span class="mf">1e9</span>

    <span class="c1"># if crop_chirp_start is not None:</span>
    <span class="n">chirps</span> <span class="o">=</span> <span class="n">chirps</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">chirp_time</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">crop_chirp_start</span><span class="p">,</span> <span class="n">crop_chirp_end</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">drop_noisy_chirps</span><span class="p">:</span>
        <span class="n">bad_chirps</span> <span class="o">=</span>  <span class="n">chirps</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">chirps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">clip_threshold</span><span class="p">)</span>
        <span class="n">good_bursts</span> <span class="o">=</span> <span class="n">bad_chirps</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;chirp_time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;chirp_num&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_chirps</span>
        <span class="n">chirps</span> <span class="o">=</span> <span class="n">chirps</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">good_bursts</span><span class="p">)</span>
        <span class="n">chirps</span> <span class="o">=</span> <span class="n">chirps</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">chirps</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;chirp_time&#39;</span><span class="p">)</span><span class="o">&lt;</span><span class="n">clip_threshold</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">demean</span><span class="p">:</span>
        <span class="n">chirps</span> <span class="o">=</span> <span class="n">chirps</span> <span class="o">-</span> <span class="n">chirps</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;chirp_time&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">detrend</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">chirps</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="s1">&#39;chirp_time&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">chirps</span><span class="o">.</span><span class="n">chirp_time</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">polyfit_coefficients</span><span class="p">)</span>
        <span class="n">chirps</span> <span class="o">=</span> <span class="n">chirps</span> <span class="o">-</span> <span class="n">fit</span>

    <span class="k">if</span> <span class="n">stack</span><span class="p">:</span>   
        <span class="n">chirps</span> <span class="o">=</span> <span class="n">chirps</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;chirp_num&#39;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># note on variable naming below: s stands for the pre-fft signal, following others&#39; notation, w stands for windowed, p stands for padding, and so on</span>
   
    <span class="c1"># window</span>
    <span class="n">window</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">blackman</span><span class="p">(</span><span class="n">chirps</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">dims</span> <span class="o">=</span> <span class="s1">&#39;chirp_time&#39;</span><span class="p">)</span>
    <span class="n">s_w</span> <span class="o">=</span> <span class="n">chirps</span> <span class="o">*</span> <span class="n">window</span>  
    
    <span class="c1"># pad</span>
    <span class="n">s_wp</span> <span class="o">=</span> <span class="n">s_w</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">chirp_time</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">Nt</span><span class="o">*</span><span class="n">pad_factor</span><span class="o">-</span><span class="n">Nt</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  

    <span class="c1"># roll</span>
    <span class="n">s_wpr</span> <span class="o">=</span> <span class="n">s_wp</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">chirp_time</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">Nt</span><span class="o">*</span><span class="n">pad_factor</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>  

    <span class="k">if</span> <span class="n">contains_dask_array</span><span class="p">(</span><span class="n">s_wpr</span><span class="p">):</span>
        <span class="n">s_wpr</span> <span class="o">=</span> <span class="n">s_wpr</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;chirp_time&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">})</span>

    <span class="c1"># fft</span>
    <span class="n">S_wpr</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">,</span> 
                        <span class="n">s_wpr</span><span class="p">,</span>
                        <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;chirp_time&quot;</span><span class="p">]],</span>
                        <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;chirp_time&quot;</span><span class="p">]])</span>
    
    <span class="c1"># scale for padding</span>
    <span class="n">S_wpr</span> <span class="o">=</span> <span class="n">S_wpr</span><span class="o">/</span><span class="n">s_wpr</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pad_factor</span><span class="p">)</span> 
    
    <span class="k">if</span> <span class="n">scale_for_window</span><span class="p">:</span>
        <span class="n">S_wpr</span> <span class="o">=</span> <span class="n">S_wpr</span><span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">blackman</span><span class="p">(</span><span class="n">Nt</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># scale for window</span>
    
    <span class="c1"># compute range</span>
    <span class="n">indexes</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s_wpr</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> 
    <span class="n">frequencies</span>  <span class="o">=</span> <span class="n">indexes</span> <span class="o">*</span> <span class="n">sampling_frequency</span><span class="o">/</span><span class="n">s_wpr</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">size</span>
    <span class="n">profile_range</span> <span class="o">=</span> <span class="n">freq2range</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span>

    <span class="c1"># reference array</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">S_wpr</span><span class="o">.</span><span class="n">chirp_time</span><span class="p">))</span><span class="o">/</span><span class="n">pad_factor</span>
    <span class="n">phiref</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">f_c</span><span class="o">*</span><span class="n">m</span><span class="o">/</span><span class="n">B</span> <span class="o">-</span>  <span class="n">m</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">K</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">B</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">S_wprr</span> <span class="o">=</span> <span class="n">S_wpr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">phiref</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">))</span>
    <span class="n">S_wprr</span> <span class="o">=</span> <span class="n">S_wprr</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">)</span>
    <span class="n">S_wprr</span> <span class="o">=</span> <span class="n">S_wprr</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;chirp_time&#39;</span><span class="p">:</span> <span class="s1">&#39;profile_range&#39;</span><span class="p">})</span>
    <span class="n">S_wprr</span><span class="p">[</span><span class="s1">&#39;profile_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile_range</span>

    <span class="c1"># crop to max_range</span>
    <span class="k">if</span> <span class="n">max_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">max_range</span> <span class="o">=</span> <span class="n">S_wprr</span><span class="o">.</span><span class="n">profile_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">S_wprr</span> <span class="o">=</span> <span class="n">S_wprr</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">profile_range</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">S_wprr</span><span class="o">.</span><span class="n">profile_range</span><span class="o">.</span><span class="n">size</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">S_wprr</span> <span class="o">=</span> <span class="n">S_wprr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">S_wprr</span><span class="o">.</span><span class="n">profile_range</span> <span class="o">&lt;=</span> <span class="n">max_range</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># add attributes</span>
    <span class="n">S_wprr</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;profile&#39;</span> 
    <span class="n">S_wprr</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
    <span class="n">S_wprr</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;complex profile computed from the fourier transform of the de-ramped chirp&#39;</span>
    <span class="n">S_wprr</span><span class="o">.</span><span class="n">profile_range</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;depth&#39;</span>
    <span class="n">S_wprr</span><span class="o">.</span><span class="n">profile_range</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;meters&#39;</span>
    <span class="n">S_wprr</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constants</span>

    <span class="k">return</span> <span class="n">S_wprr</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="utils.computeStrainRates">
    <p>def <span class="ident">computeStrainRates</span>(</p><p>self, lower_limit_on_fit=800)</p>
    </div>
    

    
  
    <div class="desc"><p>Compute strain rates from a dataset of ApRES data. For use by the function <code>compute_displacement</code></p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-utils.computeStrainRates', this);">Show source &equiv;</a></p>
  <div id="source-utils.computeStrainRates" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">computeStrainRates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lower_limit_on_fit</span> <span class="o">=</span> <span class="mi">800</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute strain rates from a dataset of ApRES data. For use by the function `compute_displacement`&quot;&quot;&quot;</span>
    <span class="n">velocity_cropped</span> <span class="o">=</span> <span class="bp">self</span>\
            <span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>\
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_depth</span> <span class="o">&lt;</span> <span class="n">lower_limit_on_fit</span><span class="p">)</span>
    
    <span class="n">fit_ds</span> <span class="o">=</span> <span class="n">velocity_cropped</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="s1">&#39;bin_depth&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">full</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            
    <span class="n">strain_rate</span> <span class="o">=</span> <span class="n">fit_ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">degree</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">polyfit_coefficients</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;strain_rate&#39;</span><span class="p">)</span>

    <span class="n">surface_intercept</span> <span class="o">=</span>  <span class="n">fit_ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">degree</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">polyfit_coefficients</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;surface_intercept&#39;</span><span class="p">)</span> 

    <span class="c1"># R^2</span>
    <span class="n">y_mean</span> <span class="o">=</span> <span class="n">velocity_cropped</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;bin_depth&#39;</span><span class="p">)</span>
    <span class="n">SS_tot</span> <span class="o">=</span> <span class="p">((</span><span class="n">velocity_cropped</span> <span class="o">-</span> <span class="n">y_mean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="s1">&#39;bin_depth&#39;</span><span class="p">)</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">fit_ds</span><span class="o">.</span><span class="n">polyfit_residuals</span><span class="o">/</span><span class="n">SS_tot</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;r_squared&#39;</span><span class="p">)</span>

    <span class="c1"># add attrs</span>
    <span class="n">strain_rate</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1/year&#39;</span>
    <span class="n">strain_rate</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;vertical strain rate in upper </span><span class="si">{</span><span class="n">lower_limit_on_fit</span><span class="si">}</span><span class="s2"> m&quot;</span>
    <span class="n">strain_rate</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;lower_limit_on_fit_meters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower_limit_on_fit</span>

    <span class="n">surface_intercept</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;meters/year&#39;</span>
    <span class="n">surface_intercept</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;vertical velocity at the surface from the linear fit&#39;</span>
    <span class="n">surface_intercept</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;lower_limit_on_fit_meters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower_limit_on_fit</span>
    
    <span class="n">R2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;r-squared value for the linear fit&#39;</span>
    <span class="n">R2</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> 
    
    <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">strain_rate</span><span class="p">,</span> <span class="n">surface_intercept</span><span class="p">,</span> <span class="n">R2</span><span class="p">])</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="utils.compute_coherence">
    <p>def <span class="ident">compute_coherence</span>(</p><p>b1_binned, b2_binned)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-utils.compute_coherence', this);">Show source &equiv;</a></p>
  <div id="source-utils.compute_coherence" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">compute_coherence</span><span class="p">(</span><span class="n">b1_binned</span><span class="p">,</span> <span class="n">b2_binned</span><span class="p">):</span>
    <span class="c1"># compute the coherence</span>
    <span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="n">b1_binned</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">b2_binned</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;sample_in_bin&quot;</span><span class="p">)</span>
    <span class="n">bottom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b1_binned</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;sample_in_bin&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b2_binned</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;sample_in_bin&quot;</span><span class="p">))</span>
    <span class="n">coherence</span> <span class="o">=</span> <span class="p">(</span><span class="n">top</span><span class="o">/</span><span class="n">bottom</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;coherence&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">top</span><span class="o">/</span><span class="n">bottom</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;coherence&quot;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="utils.compute_displacement">
    <p>def <span class="ident">compute_displacement</span>(</p><p>profile1_unaligned: xarray.core.dataarray.DataArray, profile2_unaligned: xarray.core.dataarray.DataArray, bin_size: int = 20, lower_limit_on_fit: float = 800.0)</p>
    </div>
    

    
  
    <div class="desc"><p>Compute displacement, coherence, and related uncertainties for binned time series data.</p>
<p>Parameters:
- profile1_unaligned (xr.DataArray): Unaligned time series data for the first measurement.
- profile2_unaligned (xr.DataArray): Unaligned time series data for the second measurement.
- bin_size (int, optional): Size of the vertical bins. Default is 20.</p>
<p>Returns:
xr.Dataset: Timeseries of profiles of coherence, phase, displacement, and associated uncertainties, binned in depth.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-utils.compute_displacement', this);">Show source &equiv;</a></p>
  <div id="source-utils.compute_displacement" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">compute_displacement</span><span class="p">(</span><span class="n">profile1_unaligned</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> 
                        <span class="n">profile2_unaligned</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> 
                        <span class="n">bin_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> 
                        <span class="n">lower_limit_on_fit</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">800.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute displacement, coherence, and related uncertainties for binned time series data.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - profile1_unaligned (xr.DataArray): Unaligned time series data for the first measurement.</span>
<span class="sd">    - profile2_unaligned (xr.DataArray): Unaligned time series data for the second measurement.</span>
<span class="sd">    - bin_size (int, optional): Size of the vertical bins. Default is 20.</span>

<span class="sd">    Returns:</span>
<span class="sd">    xr.Dataset: Timeseries of profiles of coherence, phase, displacement, and associated uncertainties, binned in depth.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">profiles</span> <span class="o">=</span> <span class="n">combine_profiles</span><span class="p">(</span><span class="n">profile1_unaligned</span><span class="p">,</span> <span class="n">profile2_unaligned</span><span class="p">)</span>

    <span class="n">profiles_binned</span> <span class="o">=</span> <span class="n">bin_profiles</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">bin_size</span><span class="p">)</span>

    <span class="n">coherence</span> <span class="o">=</span> <span class="n">compute_coherence</span><span class="p">(</span><span class="n">profiles_binned</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">shot_number</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">profiles_binned</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">shot_number</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
   
    <span class="c1"># add attributes related to the bin_depth</span>
    <span class="n">coherence</span><span class="o">.</span><span class="n">bin_depth</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span>
    <span class="n">coherence</span><span class="o">.</span><span class="n">bin_depth</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;depth to the center of each bin&quot;</span>
    <span class="n">coherence</span><span class="o">.</span><span class="n">bin_depth</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;standard_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bin depth&quot;</span>         

    <span class="c1"># add attributes related to the coherence</span>
    <span class="n">coherence</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;unitless&quot;</span>
    <span class="n">coherence</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;complex coherence between measurements&quot;</span>

    <span class="c1"># compute the phase and add attributes</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="o">-</span><span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">,</span> <span class="n">coherence</span><span class="p">,</span> <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;allowed&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;phase&quot;</span><span class="p">)</span>
    <span class="n">phase</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;radians&quot;</span>
    <span class="n">phase</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;coherence phase&quot;</span>

    <span class="c1"># compute phase uncertainties</span>
    <span class="n">phase_uncertainty</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">coherence</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">1.</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">coherence</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">bin_size</span><span class="p">)))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;phase_uncertainty&#39;</span><span class="p">)</span>
    <span class="n">phase_uncertainty</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;radians&quot;</span>
    <span class="n">phase_uncertainty</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;uncertainty in coherence phase&quot;</span>

    <span class="c1"># compute the displacement</span>
    <span class="n">displacement</span> <span class="o">=</span> <span class="n">phase2range</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;displacement&quot;</span><span class="p">)</span>
    <span class="n">displacement</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span>
    <span class="n">displacement</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;displacement since previous measurement&quot;</span>

    <span class="c1"># compute the displacement uncertainty</span>
    <span class="n">disp_uncertainty</span> <span class="o">=</span> <span class="n">phase2range</span><span class="p">(</span><span class="n">phase_uncertainty</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;disp_uncertainty&#39;</span><span class="p">)</span>
    <span class="n">disp_uncertainty</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;m&quot;</span>
    <span class="n">disp_uncertainty</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;long_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;uncertainty in displacement since previous measurement&quot;</span>

    <span class="n">dt_years</span> <span class="o">=</span> <span class="p">((</span><span class="n">profiles</span><span class="o">.</span><span class="n">profile_time</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">shot_number</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">profiles</span><span class="o">.</span><span class="n">profile_time</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">shot_number</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">365.25</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;dt_years&#39;</span><span class="p">)</span>
    <span class="n">dt_years</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;years&#39;</span>
    <span class="n">dt_years</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Time between shots&#39;</span>
    <span class="n">dt_years</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Time in years between shots used in each measurement of displacement, vertical velocity, etc. dt_years[i] is the time between shot [j] and shot [j-1]&#39;</span>

    <span class="c1"># vertical velocity</span>
    <span class="n">velocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">displacement</span> <span class="o">/</span> <span class="n">dt_years</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;velocity&#39;</span><span class="p">)</span>
    <span class="n">velocity</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;meters/year&#39;</span>
    <span class="n">velocity</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;long_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Vertical velocity&#39;</span>

    <span class="c1"># strain rates</span>
    <span class="n">strain_rates</span> <span class="o">=</span> <span class="n">velocity</span><span class="o">.</span><span class="n">computeStrainRates</span><span class="p">(</span><span class="n">lower_limit_on_fit</span> <span class="o">=</span> <span class="n">lower_limit_on_fit</span><span class="p">)</span>

    <span class="c1"># combine to an xarray dataset</span>
    <span class="n">da_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">profiles</span><span class="p">,</span> <span class="n">coherence</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">phase_uncertainty</span><span class="p">,</span> <span class="n">displacement</span><span class="p">,</span> <span class="n">disp_uncertainty</span><span class="p">,</span> <span class="n">velocity</span><span class="p">,</span> <span class="n">strain_rates</span><span class="p">]</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">da_list</span><span class="p">)</span>

    <span class="c1"># add attributes related to this processing</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;bin_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_size</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Time series of profiles of coherence, phase, displacement, and associated uncertainties, binned in depth.&quot;</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;processing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Created by the compute_displacement function in xapres using a bin size of </span><span class="si">{</span><span class="n">bin_size</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">ds</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="utils.contains_dask_array">
    <p>def <span class="ident">contains_dask_array</span>(</p><p>dataarray)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-utils.contains_dask_array', this);">Show source &equiv;</a></p>
  <div id="source-utils.contains_dask_array" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">contains_dask_array</span><span class="p">(</span><span class="n">dataarray</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataarray</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="utils.dB">
    <p>def <span class="ident">dB</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>A function to convert profile data to decibels.</p>
<p>The function is added to xarray dataarrays as a bound method in two functions.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-utils.dB', this);">Show source &equiv;</a></p>
  <div id="source-utils.dB" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">dB</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function to convert profile data to decibels.</span>
<span class="sd">    </span>
<span class="sd">    The function is added to xarray dataarrays as a bound method in two functions. </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> 
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="utils.default_constants">
    <p>def <span class="ident">default_constants</span>(</p><p>)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-utils.default_constants', this);">Show source &equiv;</a></p>
  <div id="source-utils.default_constants" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">default_constants</span><span class="p">():</span>
    <span class="n">constants</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>               <span class="c1"># chirp duration [s]</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;f_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">200e6</span>         <span class="c1"># starting frequency [Hz]</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;f_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">400e6</span>         <span class="c1"># ending frequency [Hz]</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;f_2&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">constants</span><span class="p">[</span><span class="s1">&#39;f_1&#39;</span><span class="p">]</span>          <span class="c1"># bandwidth [Hz]</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">constants</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>            <span class="c1"># rate of chnge of frequency [Hz/s]</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">300000000.0</span>     <span class="c1"># speed of light in a vacuum [m/s]</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;ep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.18</span>           <span class="c1"># permittivity of ice</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;f_c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">constants</span><span class="p">[</span><span class="s1">&#39;f_2&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">constants</span><span class="p">[</span><span class="s1">&#39;f_1&#39;</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>   <span class="c1"># center frequency [Hz]</span>
    <span class="n">constants</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">40000</span>        <span class="c1"># time step [s]</span>

    <span class="k">return</span> <span class="n">constants</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="utils.displacement_timeseries">
    <p>def <span class="ident">displacement_timeseries</span>(</p><p>self: xarray.core.dataarray.DataArray, offset: int = 1, bin_size: int = 20, lower_limit_on_fit: float = 800.0)</p>
    </div>
    

    
  
    <div class="desc"><p>Compute displacement, phase, coherence and associated uncertainties, as functions of depth and time, given a time series of complex ApRES profiles. </p>
<p>Profiles offset by a user-defined number of time steps are compared to compute the time series of displacement. </p>
<p>The time interval between outputted profiles is offset*dt where dt is the time between measurements. </p>
<p>The profiles of displacement etc. are binned in depth, with bin_size samples in each bin.</p>
<p>Parameters:
- self (xr.DataArray): The input data array containing a time series of complex profiles.
- offset (int, optional): The time offset between the two time series. Default is 1.
- bin_size (int, optional): Size of the vertical bins. Default is 20.</p>
<p>Returns:
xr.Dataset: Timeseries of profiles of coherence, phase, displacement, and associated uncertainties, binned in depth.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-utils.displacement_timeseries', this);">Show source &equiv;</a></p>
  <div id="source-utils.displacement_timeseries" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">displacement_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> 
                            <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  
                            <span class="n">bin_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> 
                            <span class="n">lower_limit_on_fit</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">800.0</span><span class="p">):</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute displacement, phase, coherence and associated uncertainties, as functions of depth and time, given a time series of complex ApRES profiles. </span>

<span class="sd">    Profiles offset by a user-defined number of time steps are compared to compute the time series of displacement. </span>
<span class="sd">    </span>
<span class="sd">    The time interval between outputted profiles is offset*dt where dt is the time between measurements. </span>

<span class="sd">    The profiles of displacement etc. are binned in depth, with bin_size samples in each bin.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - self (xr.DataArray): The input data array containing a time series of complex profiles.</span>
<span class="sd">    - offset (int, optional): The time offset between the two time series. Default is 1.</span>
<span class="sd">    - bin_size (int, optional): Size of the vertical bins. Default is 20.</span>

<span class="sd">    Returns:</span>
<span class="sd">    xr.Dataset: Timeseries of profiles of coherence, phase, displacement, and associated uncertainties, binned in depth.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># extract two time series</span>
    <span class="n">profile1_unaligned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">offset</span><span class="p">))</span>
    <span class="n">profile2_unaligned</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span>
    
    <span class="c1"># compute the binned coherence, phase, and displacement, with uncertainties and put them into an xarray dataset  </span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">compute_displacement</span><span class="p">(</span><span class="n">profile1_unaligned</span><span class="p">,</span> 
                              <span class="n">profile2_unaligned</span><span class="p">,</span> 
                              <span class="n">bin_size</span> <span class="o">=</span> <span class="n">bin_size</span><span class="p">,</span>
                              <span class="n">lower_limit_on_fit</span> <span class="o">=</span> <span class="n">lower_limit_on_fit</span><span class="p">)</span>

    <span class="c1"># add attributes related to the this processing</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;processing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Created by the displacement_timeseries function in xapres using an offset of </span><span class="si">{</span><span class="n">offset</span><span class="si">}</span><span class="s2"> and bin size of </span><span class="si">{</span><span class="n">bin_size</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="w"> </span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">ds</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="utils.phase2range">
    <p>def <span class="ident">phase2range</span>(</p><p>phi, lambdac=0.5608, rc=None, K=200000000.0, ci=168230000.0)</p>
    </div>
    

    
  
    <div class="desc"><p>Convert phase difference to range for FMCW radar
Parameters</p>
<hr>
<p>lambdac: float
    wavelength (m) at center frequency
rc: float; optional
    coarse range of bin center (m)
K:  float; optional
    chirp gradient (rad/s/s)
ci: float; optional
    propagation velocity (m/s)</p>
<h3 id="original-matlab-file-notes">Original Matlab File Notes</h3>
<p>Craig Stewart
2014/6/10</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-utils.phase2range', this);">Show source &equiv;</a></p>
  <div id="source-utils.phase2range" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">phase2range</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> 
                <span class="n">lambdac</span><span class="o">=</span><span class="mf">0.5608</span><span class="p">,</span> 
                <span class="n">rc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                <span class="n">K</span><span class="o">=</span><span class="mf">2e8</span><span class="p">,</span> 
                <span class="n">ci</span><span class="o">=</span><span class="mf">1.6823e8</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert phase difference to range for FMCW radar</span>
<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        lambdac: float</span>
<span class="sd">            wavelength (m) at center frequency</span>
<span class="sd">        rc: float; optional</span>
<span class="sd">            coarse range of bin center (m)</span>
<span class="sd">        K:  float; optional</span>
<span class="sd">            chirp gradient (rad/s/s)</span>
<span class="sd">        ci: float; optional</span>
<span class="sd">            propagation velocity (m/s)</span>
<span class="sd">        ### Original Matlab File Notes ###</span>
<span class="sd">        Craig Stewart</span>
<span class="sd">        2014/6/10</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">K</span><span class="p">,</span><span class="n">ci</span><span class="p">])</span> <span class="ow">or</span> <span class="n">rc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># First order method</span>
            <span class="c1"># Brennan et al. (2014) eq 15</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">lambdac</span><span class="o">*</span><span class="n">phi</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Precise</span>
            <span class="c1"># Appears to be from Stewart (2018) eqn 4.8, with tau = 2*R/ci and omega_c = 2 pi /lambdac, where R is the range</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">phi</span><span class="o">/</span><span class="p">((</span><span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">lambdac</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">rc</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span><span class="o">*</span><span class="n">K</span><span class="o">/</span><span class="n">ci</span><span class="o">**</span><span class="mf">2.</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">r</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="utils.sonify">
    <p>def <span class="ident">sonify</span>(</p><p>self, play=True, save=False, wav_filename=&#39;chirp&#39;)</p>
    </div>
    

    
  
    <div class="desc"><p>A function to sonify a chirp - play the signal as a sound.</p>
<p>The function is added to xarray dataarrays as a bound method in two functions. </p>
<p>It requires soundfile and sounddevice to be installed.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-utils.sonify', this);">Show source &equiv;</a></p>
  <div id="source-utils.sonify" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">sonify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
           <span class="n">play</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
           <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
           <span class="n">wav_filename</span><span class="o">=</span><span class="s2">&quot;chirp&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function to sonify a chirp - play the signal as a sound.</span>
<span class="sd">     </span>
<span class="sd">    The function is added to xarray dataarrays as a bound method in two functions. </span>
<span class="sd">    </span>
<span class="sd">    It requires soundfile and sounddevice to be installed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>     
        <span class="kn">import</span> <span class="nn">soundfile</span> <span class="k">as</span> <span class="nn">sf</span>
        <span class="kn">import</span> <span class="nn">sounddevice</span> <span class="k">as</span> <span class="nn">sd</span> 
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sounddevice and soundfile are required to sonify the chirps. pip install them if you need this feature&quot;</span><span class="p">)</span> 

    <span class="c1"># make sure the input is just one chirp    </span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">size</span><span class="p">:</span> 
        <span class="k">raise</span> <span class="ne">BaseException</span><span class="p">(</span><span class="s1">&#39;sonify only works for single chirps.&#39;</span><span class="p">)</span>    

    <span class="c1"># subset the chirp to remove popping</span>
    <span class="n">chirp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">chirp_time</span> <span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span><span class="o">-</span><span class="mi">500</span><span class="p">))</span>

    <span class="c1"># convert to a numpy array and remove singleton dimensions</span>
    <span class="n">chirp_values</span> <span class="o">=</span> <span class="n">chirp</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">chirp</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># convert the start and end time of the subsetted chirp to seconds, dealing with the cases when chirp.chirp_time is numpy array and when it is a timeselta64</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">startTimeInSeconds</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">endTimeInSeconds</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">):</span>
        <span class="n">startTimeInSeconds</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>
        <span class="n">endTimeInSeconds</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>

    <span class="c1"># calculate the sample rate </span>
    <span class="n">samplerate</span> <span class="o">=</span> <span class="n">chirp</span><span class="o">.</span><span class="n">chirp_time</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="n">endTimeInSeconds</span> <span class="o">-</span> <span class="n">startTimeInSeconds</span><span class="p">)</span>
    <span class="n">samplerate</span> <span class="o">=</span> <span class="n">samplerate</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">play</span><span class="p">:</span>
        <span class="n">sd</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">chirp_values</span><span class="p">,</span> <span class="n">samplerate</span><span class="o">=</span><span class="n">samplerate</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
        <span class="n">sf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">wav_filename</span><span class="si">}</span><span class="s2"> .wav&quot;</span><span class="p">,</span> <span class="n">chirp_values</span><span class="p">,</span> <span class="n">samplerate</span><span class="o">=</span><span class="n">samplerate</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  


  </section>
</article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Generated by <a href="https://github.com/timothycrosley/pdocs">pdocs 1.2.0</a>
    </p>
  </footer>
</div>
</body>
</html>